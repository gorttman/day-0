---
# Read the actual NodePorts so output is always correct
- name: Read ArgoCD service
  kubernetes.core.k8s_info:
    kind: Service
    namespace: argocd
    name: argocd-server
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: argocd_svc

- name: Read Dashboard service
  kubernetes.core.k8s_info:
    kind: Service
    namespace: kubernetes-dashboard
    name: kubernetes-dashboard
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: dash_svc

- name: Get ArgoCD initial admin secret
  kubernetes.core.k8s_info:
    kind: Secret
    name: argocd-initial-admin-secret
    namespace: argocd
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: argocd_admin_secret

- name: Show ArgoCD admin password
  ansible.builtin.debug:

- name: Show ArgoCD and Kubernetes Dashboard credentials
  ansible.builtin.debug:
    msg:
      - "ArgoCD UI: https://{{ ansible_default_ipv4.address }}:{{ (argocd_svc.resources[0].spec.ports | selectattr('port','equalto',443) | list | first).nodePort }}"
      - "{{ argocd_admin_secret.resources[0].data.password | b64decode }}"
      - "Kubernetes Dashboard UI: https://{{ ansible_default_ipv4.address }}:{{ (dash_svc.resources[0].spec.ports | selectattr('port','equalto',443) | list | first).nodePort }}"
      - "Kubernetes Dashboard token: {{ dashboard_token.stdout }}"
