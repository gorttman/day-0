---
- name: Ensure argocd namespace exists
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: argocd

- name: Install ArgoCD core manifests
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    namespace: argocd
    state: present
    src: https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

- name: Create ArgoCD Git credentials secret
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ bootstrap_repos[0].name }}"
        namespace: argocd
        labels:
          argocd.argoproj.io/secret-type: repository
      stringData:
        type: git
        url: "{{ bootstrap_repos[0].repo }}"
        username: "{{ git_user }}"
        password: "{{ git_token }}"

- name: Apply ArgoCD bootstrap Application
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    namespace: argocd
    src: "{{ bootstrap_app_path }}"

- name: Apply Kubernetes Dashboard manifest
  kubernetes.core.k8s:
    state: present
    src: https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
    kubeconfig: "{{ kubeconfig }}"

- name: Get ArgoCD initial admin secret
  kubernetes.core.k8s_info:
    kind: Secret
    namespace: argocd
    name: argocd-initial-admin-secret
    kubeconfig: "{{ kubeconfig }}"
  register: argocd_admin_secret
  become: true
